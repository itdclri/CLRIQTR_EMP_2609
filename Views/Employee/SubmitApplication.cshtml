@model CLRIQTR_EMP.Models.NewApplicationModel
@*@{
        ViewBag.Title = "New Application - Step 2";
        Layout = "~/Views/Shared/_Layout.cshtml";

        var typeOrder = new List<string>
        {
            "I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X",
            "XI", "XII", "XIII", "XIV", "XV"
        };

        string lowerType = null;
        if (!string.IsNullOrEmpty(Model.QuarterType))
        {
            var idx = typeOrder.IndexOf(Model.QuarterType.Trim());
            if (idx > 0)
            {
                lowerType = typeOrder[idx - 1];
            }
        }

    }*@

@{
    bool isTypeV = Model.QuarterType == "V";

    // --- NEW LOGIC ---
    // This block automatically determines the Permanent/Temporary status.

    // 1. Define probation lists based on designation code
    // (Using codes from our previous conversation)
    var probation1YearCodes = new List<string> { "7", "20", "25" };
    var probation2YearCodes = new List<string> {
        "30", "32", "35", "36", "38", "40", "41", "45", "48"
    };

    // 2. Get data from Model (must be populated in Controller)
    var desigCode = Model.DesignationCode;
    var doj = Model.DateOfJoining; // This is your DateTime?
    var today = DateTime.Now;

    bool isTemporary = false;

    // --- START OF FIX ---
    // First, check if DOJ actually has a value
    if (doj.HasValue)
    {
        // Now it's safe to use doj.Value (which is a regular DateTime)
        if (probation1YearCodes.Contains(desigCode))
        {
            if (doj.Value.AddYears(1) > today) // Use .Value
            {
                isTemporary = true; // Less than 1 year service
            }
        }
        else if (probation2YearCodes.Contains(desigCode))
        {
            if (doj.Value.AddYears(2) > today) // Use .Value
            {
                isTemporary = true; // Less than 2 years service
            }
        }
    }
    // If doj.HasValue is false (meaning DOJ is null),
    // isTemporary will just stay 'false' (Permanent), which is safe.
    // --- END OF FIX ---


    // 4. Set the model value.
    if (isTemporary)
    {
        Model.PermanentOrTemporary = "Temporary";
    }
    else
    {
        Model.PermanentOrTemporary = "Permanent";
    }
    // --- END OF NEW LOGIC ---
}

<style>
    .navbar-nav .nav-link.active {
        font-weight: bold;
        color: #0d6efd; /* Bootstrap primary color */
    }
</style>

<nav class="navbar navbar-expand navbar-light bg-light mb-4">
    <div class="container">
        <ul class="navbar-nav me-auto">
            <li class="nav-item">
                <a class="nav-link active" href="@Url.Action("Index", "Employee")">
                    <i class="bi bi-file-earmark-plus"></i> New Application
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" aria-current="page" href="@Url.Action("ViewDrafts", "Employee")">
                    <i class="bi bi-folder-fill"></i> My Applications
                </a>
            </li>
        </ul>

        <div class="d-flex align-items-center ms-auto">
            <div class="navbar-text me-3">
                <i class="bi bi-person-badge"></i> Employee Number : <b>@Session["EmpNo"]</b>
            </div>
        </div>

        <ul class="navbar-nav mb-0">
            <li class="nav-item">
                <a class="nav-link text-danger" style="font-size: 1.1rem;" href="@Url.Action("Logout", "Login")">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </a>
            </li>
        </ul>
    </div>
</nav>

<h2 class="mt-4 text-center">New Application</h2>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="card mt-4 shadow-sm p-4">
    @using (Html.BeginForm("SubmitApplication", "Employee", FormMethod.Post))
    {
        @Html.AntiForgeryToken()
        @Html.HiddenFor(m => m.ApplyingForQuarters)
        @Html.HiddenFor(m => m.ApplyingForScientistQuarters)
        @Html.HiddenFor(m => m.QtrAppNo)
        @Html.HiddenFor(m => m.SaQtrAppNo)

        <div class="row mb-3 align-items-center">
            <label class="col-md-6 col-form-label fw-bold">Date of Application</label>
            <div class="col-md-6">
                <input type="text" readonly class="form-control-plaintext" value="@DateTime.Now.ToString("dd/MM/yyyy")" />
            </div>
        </div>

        <div class="row mb-3 align-items-center">
            <label class="col-md-6 col-form-label fw-bold">Type Eligible</label>
            <div class="col-md-6">
                <input type="text" readonly class="form-control-plaintext" value="@Model.QuarterType" />
            </div>
        </div>

        <div class="row mb-3 align-items-center">
            @Html.LabelFor(m => m.PresentResidence, "Present Place of Residence with Full Address", htmlAttributes: new { @class = "col-md-6 col-form-label fw-bold" })
            <div class="col-md-6">
                @Html.TextBoxFor(m => m.PresentResidence, new { @class = "form-control", placeholder = "Enter your present residence address" })
                @Html.ValidationMessageFor(m => m.PresentResidence, "", new { @class = "text-danger" })
            </div>
        </div>

        if (isTypeV)
        {
            <div class="row mb-3 align-items-center">
                <label class="col-md-6 col-form-label fw-bold">
                    Whether interested for type IV (in case of applicants entitled for type V only)?<br />
                    If so, separate application for type V should be given
                </label>
                <div class="col-md-6">
                    <div class="form-check form-check-inline">
                        @Html.RadioButtonFor(
                                m => m.InterestedForLowerType,
                                "Interested",
                                new { @class = "form-check-input", id = "lowerYes" }
                            )
                        <label class="form-check-label fw-bold" for="lowerYes">Interested</label>
                    </div>
                    <div class="form-check form-check-inline">
                        @Html.RadioButtonFor(
                                m => m.InterestedForLowerType,
                                "Not Interested",
                                new { @class = "form-check-input", id = "lowerNo" }
                            )
                        <label class="form-check-label fw-bold" for="lowerNo">Not Interested</label>
                    </div>
                </div>
            </div>
        }

        <div class="row mb-3 align-items-center">
            <label class="col-md-6 col-form-label fw-bold">Whether the applicant owns a house either in his / her own name or in the name of his / her spouse within the municipal limits of Chennai.</label>
            <div class="col-md-6">
                <div class="form-check form-check-inline">
                    @Html.RadioButtonFor(m => m.OwnHouse, "Yes", new { @class = "form-check-input", id = "ownHouseYes" })
                    <label class="form-check-label fw-bold" for="ownHouseYes">Yes</label>
                </div>
                <div class="form-check form-check-inline">
                    @Html.RadioButtonFor(m => m.OwnHouse, "No", new { @class = "form-check-input", id = "ownHouseNo" })
                    <label class="form-check-label fw-bold" for="ownHouseNo">No</label>
                </div>
            </div>
        </div>

        <div id="ownHouseDetails" style="display:none; margin-left:20px;">
            <div class="row mb-3 align-items-center">
                @Html.LabelFor(m => m.OwnerName, "Owner's Name", htmlAttributes: new { @class = "col-md-6 col-form-label fw-bold" })
                <div class="col-md-6">
                    @Html.TextBoxFor(m => m.OwnerName, new { @class = "form-control" })
                    @Html.ValidationMessageFor(m => m.OwnerName, "", new { @class = "text-danger" })
                </div>
            </div>
            <div class="row mb-3 align-items-center">
                @Html.LabelFor(m => m.OwnerAddress, "Address", htmlAttributes: new { @class = "col-md-6 col-form-label fw-bold" })
                <div class="col-md-6">
                    @Html.TextBoxFor(m => m.OwnerAddress, new { @class = "form-control" })
                    @Html.ValidationMessageFor(m => m.OwnerAddress, "", new { @class = "text-danger" })
                </div>
            </div>
            <div class="row mb-3 align-items-center">
                <label class="col-md-6 col-form-label fw-bold">Whether the house is let out?</label>
                <div class="col-md-6">
                    <div class="form-check form-check-inline">
                        @Html.RadioButtonFor(m => m.HouseLetOut, "Yes", new { @class = "form-check-input", id = "letOutYes" })
                        <label class="form-check-label fw-bold" for="letOutYes">Yes</label>
                    </div>
                    <div class="form-check form-check-inline">
                        @Html.RadioButtonFor(m => m.HouseLetOut, "No", new { @class = "form-check-input", id = "letOutNo" })
                        <label class="form-check-label fw-bold" for="letOutNo">No</label>
                    </div>
                </div>
            </div>
        </div>

        <div id="rentAmountDiv" style="display:none; margin-left:40px;">
            <div class="row mb-3 align-items-center">
                <label class="col-md-6 col-form-label fw-bold">If let out, monthly rent received</label>
                <div class="col-md-6">
                    @Html.TextBoxFor(m => m.MonthlyRent, new { @class = "form-control", type = "number", min = "0" })
                    @Html.ValidationMessageFor(m => m.MonthlyRent, "", new { @class = "text-danger" })
                </div>
            </div>
        </div>

        <div class="row mb-3 align-items-center">
            <label class="col-md-6 col-form-label fw-bold">Details of Family member of the applicant as defined in Allotment Rule 2 (s)</label>
            <div class="col-md-6">
                <textarea rows="3" type="text" readonly class="form-control-plaintext">@Model.FamilyDetails</textarea>
            </div>
        </div>

        @* --- MODIFIED SECTION --- *@
        @* The radio buttons are now "disabled" and the value is set by the logic above. *@
        <div class="row mb-3 align-items-center">
            <label class="col-md-6 col-form-label fw-bold">State Whether Permanent or Temporary</label>
            <div class="col-md-6">
                <div class="form-check form-check-inline">
                    @Html.RadioButtonFor(m => m.PermanentOrTemporary, "Permanent", new { @class = "form-check-input", id = "permRadio", disabled = "disabled" })
                    <label class="form-check-label fw-bold" for="permRadio">Permanent</label>
                </div>
                <div class="form-check form-check-inline">
                    @Html.RadioButtonFor(m => m.PermanentOrTemporary, "Temporary", new { @class = "form-check-input", id = "tempRadio", disabled = "disabled" })
                    <label class="form-check-label fw-bold" for="tempRadio">Temporary</label>
                </div>

                @* IMPORTANT: Disabled inputs do not post back to the server. *@
                @* This hidden field ensures the automatically-set value is submitted. *@
                @Html.HiddenFor(m => m.PermanentOrTemporary)
            </div>
        </div>
        @* --- END OF MODIFIED SECTION --- *@


        <div id="suretyDetails" style="display:none; margin-left:20px;">
            <label class="fw-bold mb-2">If Temporary and less than 3 years service, enter surety details:</label>
            <div class="row mb-3 align-items-center">
                <label class="col-md-6 col-form-label fw-bold">Name of Surety</label>
                <div class="col-md-6">
                    @Html.TextBoxFor(m => m.SuretyName, new { @class = "form-control", placeholder = "Name of Surety" })
                    @Html.ValidationMessageFor(m => m.SuretyName, "", new { @class = "text-danger" })
                </div>
            </div>
            <div class="row mb-3 align-items-center">
                <label class="col-md-6 col-form-label fw-bold">Present Designation</label>
                <div class="col-md-6">
                    @Html.TextBoxFor(m => m.SuretyDesignation, new { @class = "form-control", placeholder = "Present Designation" })
                    @Html.ValidationMessageFor(m => m.SuretyDesignation, "", new { @class = "text-danger" })
                </div>
            </div>
            <div class="row mb-3 align-items-center">
                <label class="col-md-6 col-form-label fw-bold">Permanent Post Held</label>
                <div class="col-md-6">
                    @Html.TextBoxFor(m => m.SuretyPermanentPost, new { @class = "form-control", placeholder = "Permanent Post Held" })
                    @Html.ValidationMessageFor(m => m.SuretyPermanentPost, "", new { @class = "text-danger" })
                </div>
            </div>
        </div>

        <div class="row mb-3 align-items-center">
            <label class="col-md-6 col-form-label fw-bold">Have your services been declared essential?</label>
            <div class="col-md-6">
                <div class="form-check form-check-inline">
                    @Html.RadioButtonFor(m => m.ServicesEssential, "Yes", new { @class = "form-check-input", id = "essYes" })
                    <label class="form-check-label fw-bold" for="essYes">Yes</label>
                </div>
                <div class="form-check form-check-inline">
                    @Html.RadioButtonFor(m => m.ServicesEssential, "No", new { @class = "form-check-input", id = "essNo" })
                    <label class="form-check-label fw-bold" for="essNo">No</label>
                </div>
            </div>
        </div>

        <div class="row mb-3 align-items-center">
            <label class="col-md-6 col-form-label fw-bold">Are you a Common Cadre Officer?</label>
            <div class="col-md-6">
                <div class="form-check form-check-inline">
                    @Html.RadioButtonFor(m => m.IsCommonCadreOfficer, "Yes", new { @class = "form-check-input", id = "ccoYes" })
                    <label class="form-check-label fw-bold" for="ccoYes">Yes</label>
                </div>
                <div class="form-check form-check-inline">
                    @Html.RadioButtonFor(m => m.IsCommonCadreOfficer, "No", new { @class = "form-check-input", id = "ccoNo" })
                    <label class="form-check-label fw-bold" for="ccoNo">No</label>
                </div>
            </div>
        </div>

        <div class="row mb-3 align-items-center">
            <label class="col-md-6 col-form-label fw-bold">Whether Spouse working in Govt.(state/central)/Autonomous/PSU entitled for accommodation</label>
            <div class="col-md-6">
                <div class="form-check form-check-inline">
                    @Html.RadioButtonFor(m => m.SpouseWorking, "Yes", new { @class = "form-check-input", id = "spouseWorkingYes" })
                    <label class="form-check-label fw-bold" for="spouseWorkingYes">Yes</label>
                </div>
                <div class="form-check form-check-inline">
                    @Html.RadioButtonFor(m => m.SpouseWorking, "No", new { @class = "form-check-input", id = "spouseWorkingNo" })
                    <label class="form-check-label fw-bold" for="spouseWorkingNo">No</label>
                </div>
            </div>
        </div>

        <div id="spouseOfficeDetails" style="display:none; margin-left:20px;">
            <div class="row mb-3 align-items-center">
                @Html.LabelFor(m => m.SpouseOfficeName, "Spouse's Office Name", htmlAttributes: new { @class = "col-md-6 col-form-label fw-bold" })
                <div class="col-md-6">
                    @Html.TextBoxFor(m => m.SpouseOfficeName, new { @class = "form-control", placeholder = "Enter Spouse's Office Name" })
                    @Html.ValidationMessageFor(m => m.SpouseOfficeName, "", new { @class = "text-danger" })
                </div>
            </div>
        </div>
        if (Model.ShowDisabilityFields)
        {
            <div class="row mb-3 align-items-center">
                @Html.LabelFor(m => m.NatureOfDisability, "Nature of Disability", htmlAttributes: new { @class = "col-md-6 col-form-label fw-bold" })
                <div class="col-md-6">
                    @Html.TextBoxFor(m => m.NatureOfDisability, new { @class = "form-control", placeholder = "Specify the nature of your disability" })
                    @Html.ValidationMessageFor(m => m.NatureOfDisability, "", new { @class = "text-danger" })
                </div>
            </div>
        }

        @Html.HiddenFor(m => m.QtrAppNo)

        var isDraft = string.IsNullOrEmpty(Model.AppStatus) || Model.AppStatus == "D";
        var isFirstTime = string.IsNullOrEmpty(Model.QtrAppNo);

        <br />

        <div class="d-flex justify-content-center gap-2">
            @if (isFirstTime)
            {
                <button type="submit" name="action" value="SaveAsDraft" class="btn btn-primary px-5">Save as Draft</button>
            }
            else
            {
                <button type="submit" name="action" value="SaveAsDraft" class="btn btn-primary px-5">Save as Draft</button>
                <button type="submit" name="action" value="Submit" class="btn btn-success px-5">Submit Application</button>
            }
        </div>
    }
</div>


<script>
    console.log("--- PERMANENT/TEMPORARY DEBUG LOGS ---");
    console.log("Designation Code: '@Model.DesignationCode'");
    console.log("Date of Joining: '@Model.DateOfJoining.ToString()'");
    console.log("Status Calculated by View: '@Model.PermanentOrTemporary'");
    console.log("----------------------------------------");
</script>

@section scripts {
    <script>
        // --- Shows/hides the "Owner's Name", "Address" fields ---
        function toggleOwnHouseDetails() {
            var ownHouseYes = document.getElementById('ownHouseYes');
            var detailsDiv = document.getElementById('ownHouseDetails');

            // Show the details div only if 'Yes' is checked
            var isChecked = (ownHouseYes && ownHouseYes.checked);
            detailsDiv.style.display = isChecked ? 'block' : 'none';

            // If 'No' is checked, also hide the rent amount div
            if (!isChecked) {
                document.getElementById('rentAmountDiv').style.display = 'none';
            }
        }

        // --- Shows/hides the "Monthly Rent" field ---
        function toggleRentAmount() {
            var letOutYes = document.getElementById('letOutYes');
            var rentDiv = document.getElementById('rentAmountDiv');

            // Show the rent div only if 'Yes' is checked
            rentDiv.style.display = (letOutYes && letOutYes.checked) ? 'block' : 'none';
        }

        // --- Shows/hides the "Surety Details" ---
        function toggleSuretyDetails() {
            var tempRadio = document.getElementById('tempRadio');
            var suretyDiv = document.getElementById('suretyDetails');

            // Show the surety div only if 'Temporary' is checked
            // This will still work correctly on page load
            suretyDiv.style.display = (tempRadio && tempRadio.checked) ? 'block' : 'none';
        }

        // --- Shows/hides the "Spouse Office Name" ---
        function toggleSpouseOfficeDetails() {
            var spouseYes = document.getElementById('spouseWorkingYes');
            var detailsDiv = document.getElementById('spouseOfficeDetails');

            // Show the spouse office div only if 'Yes' is checked
            detailsDiv.style.display = (spouseYes && spouseYes.checked) ? 'block' : 'none';
        }


        // --- This part runs when the page first loads ---
        document.addEventListener('DOMContentLoaded', function () {

            // 1. Run all functions once to set the correct state on page load
            toggleOwnHouseDetails();
            toggleRentAmount();
            toggleSuretyDetails(); // This will correctly show/hide surety based on the auto-set value
            toggleSpouseOfficeDetails();

            // 2. Add "listeners" to run the functions when you click the radio buttons

            // Listeners for Own House
            document.getElementById('ownHouseYes').addEventListener('change', toggleOwnHouseDetails);
            document.getElementById('ownHouseNo').addEventListener('change', toggleOwnHouseDetails);

            // Listeners for Rent
            document.getElementById('letOutYes').addEventListener('change', toggleRentAmount);
            document.getElementById('letOutNo').addEventListener('change', toggleRentAmount);

            // Listeners for Surety
            // These listeners are no longer needed since the buttons are disabled,
            // but they don't cause any harm.
            // document.getElementById('tempRadio').addEventListener('change', toggleSuretyDetails);
            // document.getElementById('permRadio').addEventListener('change', toggleSuretyDetails);

            // Listeners for Spouse
            document.getElementById('spouseWorkingYes').addEventListener('change', toggleSpouseOfficeDetails);
            document.getElementById('spouseWorkingNo').addEventListener('change', toggleSpouseOfficeDetails);
        });
    </script>
}